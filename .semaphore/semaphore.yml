version: v1.0
name: Zephyr Project CI
agent:
  machine:
    type: e1-standard-8
    os_image: ubuntu1804

blocks:
  - name: Zephyr Tests
    task:
      secrets:
        - name: ssh_pub_key
      env_vars:
        - name: ZEPHYR_SDK_INSTALL_DIR
          value: "/home/semaphore/zephyr-sdk-0.10.0"
        - name: ZEPHYR_TOOLCHAIN_VARIANT
          value: "zephyr"
        - name: USE_CCACHE
          value: "1"
        - name: MATRIX_TOTAL
          value: "5"
      jobs:
      - name: sanitycheck
        matrix:
          - env_var: MATRIX_BUILD
            values: ["1", "2", "3", "4", "5"]
        commands:
          - env
          - cat /etc/os-release
          - sem-version python 3.7
          - sem-version c 7
          - checkout
          - ls -la
          - pwd
          - docker run -ti -u `id -u $USER` -e CCACHE_DIR=$PWD/ccache -v $PWD:/workdir:z docker.io/zephyrprojectrtos/zephyr-build:v0.10 ./scripts/sanitycheck --inline-logs -N -T tests/kernel --subset ${MATRIX_BUILD}/${MATRIX_TOTAL}
